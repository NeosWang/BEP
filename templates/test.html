<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>JBP 000</title>
    <!-- STYLES -->


    <link rel="stylesheet" href="{{ url_for('static', filename='css/nouislider.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.css') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">



    <!-- /STYLES -->
    <!-- SCRIPTS -->

    <script src="{{ url_for('static', filename='js/jquery.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js')}}"></script>

    <script src="{{ url_for('static', filename='js/echarts.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/nouislider.js')}}"></script>

    <script src="{{ url_for('static', filename='js/vis.js')}}"></script>
    <script src="{{ url_for('static', filename='js/yc.js')}}"></script>
    <script src="{{ url_for('static', filename='js/dn.js')}}"></script>

    <!-- /SCRIPTS -->



</head>

<body>
    <div class="grid-container">
        <!-- start -- network graph  -->
        <div class='network-grid'>
            <div id="network" style="width:100; height:100%;" class="network"></div>
            <span class="bottomright mb-1">
                <label for="intersection">operation: </label>
                <select id="select-union" name="select-union" onchange="unionSelect(this)">
                    <option value='1'>union</option>
                    <option value='0'>intersection</option>
                </select>

                <label for="intersection">category: </label>
                <select id="select-categorized-feature" name="select-categorized-feature"
                    onchange="featureSelect(this)"></select>
            </span>
        </div>
        <!-- end -- network graph  -->

        <!-- start -- network statistics  -->
        <div id="network-statistics-grid" class="network-statistics-grid"></div>
        <!-- end -- network statistics  -->

        <!-- start -- data upload & preview  -->
        <div id="data-preview-grid" class="data-preview-grid">
            <div class="inner-grid-1"></div>

            <div class="inner-grid-tables px-3">
                <legend>Data Preview:</legend>
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#panel-entities">Entities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#panel-relationships">Relationships</a>
                    </li>
                </ul>

                <!-- start -- tab panels -->
                <div class="tab-content">
                    <div id="panel-entities" class="container tab-pane active"><br>
                        <div class="row">
                            <div class="col-6">
                                <div>
                                    <input type="file" id="file-entities" name="file-entities">
                                </div>
                            </div>
                            <div class='col'>
                                <div>
                                    <select style="font-family: Georgia;" id="select-entities-sep"
                                        name="select-entities-sep">
                                        <option value='' selected >- separator -</option>
                                        <option value=','>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; , </option>
                                        <option value=';'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;</option>
                                        <option value='\t'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \t</option>
                                    </select>
                                </div>
                            </div>
                            <div class='col'>
                                <div>
                                    <select style="font-family: Georgia;" id="select-entities-header"
                                        name="select-entities-header">
                                        <option value='' selected >- header -</option>
                                        <option value='0'>1st line</option>
                                        <option value='1'>none</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <button id="btn-submit-entities" class="btn btn-primary-outline btn-xs float-right" value = '0'>
                                <i class="fa fa-table"></i> 
                            </button>
                        </div>

                        <div class= "mt-1">
                            <table class="table" id="table-entities"></table>
                        </div>
                    </div>

                    <div id="panel-relationships" class="container tab-pane fade"><br>
                        <div class="row">
                            <div class="col-6">
                                <div>
                                    <input type="file" id="file-relationships" name="file-relationships">
                                </div>
                            </div>
                            <div class='col'>
                                <div>
                                    <select style="font-family: Georgia" id="select-relationships-sep" name="select-relationships-sep">
                                        <option value='' >- separator -</option>
                                        <option value=','>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; , </option>
                                        <option value=';'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;</option>
                                        <option value='\t'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \t</option>
                                    </select>
                                </div>
                            </div>
                            <div class='col'>
                                <div>
                                    <select style="font-family: Georgia;" id="select-relationships-header"
                                        name="select-relationships-header">
                                        <option value='' >- header -</option>
                                        <option value='0'>1st line</option>
                                        <option value='1'>none</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div>
                            <button id="btn-submit-relationships" class="btn btn-primary-outline btn-xs float-right" value = '1'>
                                <i class="fa fa-table"></i> 
                            </button>
                        </div>
                        
                        <div class="mt-1">
                            <table class="table" id="table-relationships"></table>
                        </div>
                    </div>
                </div>
                <!-- end -- tab panels -->
            </div>
        </div>
        <!-- end -- data upload & preview  -->
        

        <div id="range-slider-grid" class="range-slider-grid">
            <div id="range-slider" class="range-slider"></div>
            <!-- start -- button for slider -->
            <span class="bottomright">
                <button class='btn-xs' value='-1' onclick="move(this.value)">
                    <i class="fa fa-step-backward" aria-hidden="true"></i>
                </button>
                <button class='btn-xs' value='0' onclick="playOrPause(this)">
                    <i id="play-or-pause" class="fa fa-play" aria-hidden="true"></i>
                </button>
                <button class='btn-xs' value='1' onclick="move(this.value)">
                    <i class="fa fa-step-forward" aria-hidden="true"></i>
                </button>
            </span>
            <!-- end -- button for slider -->
        </div>

        <div id="range-slider-side" class="range-slider-side">
            <div style="height: 50%;">
                <select id="handles" onchange="handlersSelect(this)">
                    <option value="1" selected>discrete</option>
                    <option value="2">continuous</option>
                    <option value="-3">continuous(arise)</option>
                    <option value="3"> continuous(die out) </option>
                </select>
            </div>
            <div style="height: 50%;">
                shit
            </div>
        </div>

        <div id="timeline-grid" class="timeline-grid"></div>

        <div id="timeline-zoom-range-grid" class="timeline-zoom-range-grid">
            <legend>Zoom Range:</legend>
            <div class="block">
                <label for="select-zoom">from</label>
                <select id="zoom-from" name="select-zoom"></select>
            </div>
            <div class="block">
                <label for="select-zoom">to</label>
                <select id="zoom-to" name="select-zoom"></select>
            </div>
        </div>
        <div id="timeline-measures-grid" class="timeline-measures-grid">
            <legend>Measurements:</legend>
            <input type="checkbox" class="cbxMeasurement" name="active nodes" value='0' /> active nodes <br />
            <input type="checkbox" class="cbxMeasurement" name="active nodes (pct)" value='1' /> active nodes (pct)
            <br />
            <input type="checkbox" class="cbxMeasurement" name="active relations" value='2' /> active relations <br />
            <input type="checkbox" class="cbxMeasurement" name="active density" value='3' /> active density <br />
            <input type="checkbox" class="cbxMeasurement" name="maximum clique" value='4' /> maximum clique <br />
            <input type="checkbox" class="cbxMeasurement" name="disconnected groups" value='5' /> disconnected groups
            <br />
        </div>
    </div>


    <script>


        function getDataPreview(){

        }

        function tableShowPreview(table, res, isRelationships){
            // -- start -- table header
            let th = "";
            res.columns.forEach(col => {
                if(isRelationships){
                    th += `
                        <th>
                            <select name='select-link-feature' onchange='checkLinkFeature(this)'>
                                <option>${String(col).toLowerCase()}</option>
                                <option value='1'>time</option>
                                <option value='2'>i</option>
                                <option value='3'>j</option>
                            </select>                                
                        </th>
                        `;
                }else{
                    th += `
                        <th>
                            <input type="text" class="form-control form-control-sm" value="${String(col).toLowerCase()}" aria-label="Small">              
                        </th>
                        `;
                }                
            });
            table.append(`<thead class="thead-light"> <tr>${th}</tr> </thead>`);
            // -- end -- table header

            // -- start -- table body
            let tb = ""
            res.data.forEach(row => {
                let str = "";
                row.forEach(cell => {
                    str += `<td>${cell}</td>`;
                })
                tb += `<tr>${str}</tr>`;
            });
            table.append(`<tbody>${tb}</tbody>`);
            // -- end -- table body

            // -- start -- table foot
            let tf = "";
            res.columns.forEach((col,i)=>{
                if(i==0){
                    tf+=`<td>...</td>`
                }else if(i==res.columns.length-1){
                    tf +=`<td><button class="btn btn-primary-outline btn-xs float-right"><i class="fa fa-upload"></i></button></td>`
                }else{
                    tf+=`<td></td>`
                }

            });
            table.append(`<tfoot> <tr> ${tf} </tr> </tfoot>`);
            // -- end -- table foot
        }





        /*-- start -- function on controls*/
        $(document).ready(function () {
            $('#btn-submit-entities').click(function () {

                let table = yc.cleanedElement('#table-entities');

                let toReturn = false
                let fileObj = $('#file-entities').prop('files')[0]

                if (typeof (fileObj) == "undefined" || fileObj.size <= 0) {
                    tableShowWarning(table,'file not selected');
                    toReturn = true;
                }

                let sep = $('#select-entities-sep').val()
                if (sep === '') {
                    tableShowWarning(table,'separator not selected');
                    toReturn = true;
                }

                let noneHeader = $('#select-entities-header').val();
                if (noneHeader === '') {
                    tableShowWarning(table,'header not selected');
                    toReturn = true;
                }

                if (toReturn) return;

                let isRelationships = parseInt(this.value);
                
                var param = JSON.stringify({
                    'sep': sep,
                    'noneHeader': noneHeader,
                    'isRelationships': isRelationships
                });

                var formData = new FormData();
                formData.append("file", fileObj); //加入文件对象
                formData.append("param", param)

                $.ajax({
                    type: "Post",
                    url: "/preview",
                    data: formData,
                    dataType: "json",
                    cache: false,//上传文件无需缓存
                    processData: false,//用于对data参数进行序列化处理 这里必须false
                    contentType: false, //必须
                    success: function (res) {
                        tableShowPreview(table, res,  isRelationships)
                    },
                    error: function () {
                        tableShowWarning(table,'ERROR')
                    }
                });
            });

            $('#btn-submit-relationships').click(function () {
                let table = yc.cleanedElement('#table-relationships');

                let toReturn = false

                let fileObj = $('#file-relationships').prop('files')[0]
                if (typeof (fileObj) == "undefined" || fileObj.size <= 0) {
                    tableShowWarning(table,'file not selected');
                    toReturn = true;
                }

                let sep = $('#select-relationships-sep').val()
                if (sep === "") {
                    tableShowWarning(table,'separator not selected');
                    toReturn = true;
                }

                let noneHeader = $('#select-relationships-header').val();
                if (noneHeader === "") {
                    tableShowWarning(table,'header not selected');
                    toReturn = true;
                }

                if (toReturn) return;

                let isRelationships = parseInt(this.value);

                var param = JSON.stringify({
                    'sep': sep,
                    'noneHeader': noneHeader,
                    'isRelationships': isRelationships
                });

                var formData = new FormData();
                formData.append("file", fileObj); //加入文件对象
                formData.append("param", param)

                $.ajax({
                    type: "Post",
                    url: "/preview",
                    data: formData,
                    dataType: "json",
                    cache: false,//上传文件无需缓存
                    processData: false,//用于对data参数进行序列化处理 这里必须false
                    contentType: false, //必须
                    success: function (res) {
                        tableShowPreview(table, res,  isRelationships);
                    },
                    error: function () {
                        tableShowWarning(table,'ERROR')
                    }
                });
            });


            // select summary statistics
            $('.cbxMeasurement').click(function () {
                Object.entries(gMeasurements).forEach(([k, v]) => { v.show = false })
                $('.cbxMeasurement:checkbox:checked').each((i, e) => {
                    let key = e.value;
                    let name = e.name
                    let show = e.checked;
                    if (!gMeasurements.hasOwnProperty(key)) {
                        gMeasurements[key] = {
                            data: gArrayFuncMeasurements[key](),
                            name: name
                        }
                    }
                    gMeasurements[key].show = show;
                });
                line.updateTimeline();
            });

            // select range of datazoom
            $('select[name="select-zoom"]').change(function () {
                let dataZoomSelects = $('select[name="select-zoom"]');
                let idxFrom = dataZoomSelects[0].selectedIndex;
                let idxTo = dataZoomSelects[1].selectedIndex;
                if (idxFrom >= idxTo) {
                    if (this.id == "zoom-from")
                        dataZoomSelects[1].selectedIndex = dataZoomSelects[0].selectedIndex + 1;
                    if (dataZoomSelects[1].selectedIndex == -1) {
                        dataZoomSelects[1].selectedIndex = dataZoomSelects[0].selectedIndex;
                        dataZoomSelects[0].selectedIndex--;
                    }
                    else
                        dataZoomSelects[0].selectedIndex = dataZoomSelects[1].selectedIndex - 1;
                    if (dataZoomSelects[0].selectedIndex == -1) {
                        dataZoomSelects[0].selectedIndex++;
                        dataZoomSelects[1].selectedIndex++;
                    }
                }
                line.update({
                    dataZoom: {
                        startValue: dataZoomSelects[0].selectedIndex,
                        endValue: dataZoomSelects[1].selectedIndex
                    }
                });
                slider.setRange(line.dataZoomBoundary());
            });
        });

        /*-- start -- functions for ajax */
        function tableShowWarning(table, str){
            table.append(`<tr><td class="text-danger font-weight-bold">${str}</td></tr>`)
        }




        function checkLinkFeature(select) {
            if (select.selectedIndex > 0) {
                let linkFeatureSelects = $("select[name='select-link-feature']")
                linkFeatureSelects.each((i, e) => {
                    if (e != select && e.selectedIndex == select.selectedIndex) {
                        e.selectedIndex = 0;
                    }
                });
            }
        }


        function featureSelect(select) {
            gCate = select.value;
            slider.translation(0);
        }

        function unionSelect(select) {
            gIsUnion = parseInt(select.value);
            slider.translation(0);
        }

        function handlersSelect(select) {
            slider.updateHandles(parseInt(select.value), line.dataZoomBoundary());
            slider.bindNetwork(network);
        }



        // button for slider
        function move(ctlValue) {
            slider.translation(parseInt(ctlValue));
        }

        var autoPlay = new yc.MySetInterval(function () { move(1) }, 1200);

        function playOrPause(btn) {
            let ico = document.getElementById("play-or-pause");
            if (btn.value == '0') {
                ico.classList.remove('fa-play');
                ico.classList.add('fa-pause');
                autoPlay.play();
                btn.setAttribute("value", "1");
            } else {
                ico.classList.remove('fa-pause');
                ico.classList.add('fa-play');
                autoPlay.pause();
                btn.setAttribute("value", "0");
            }
        }
        /*-- end -- function on controls*/



        /*-- start -- global variable*/
        var gIsUnion = true;
        var gCate;
        var gGraph;
        var gGraphAdj;
        var gMeasurements = {}; //{0：{data,name,show}}
        var dn = DynamicNetwork()
        const gArrayFuncMeasurements = {
            0: dn.getListNrOfVertices,
            1: dn.getListPctOfVertices,
            2: dn.getListNrOfEdges,
            3: dn.getListActiveDensity,
            4: dn.getListMaximumClique,
            5: dn.getListNrOfdisconnected
        }
        /*-- end -- global variable*/


        /* -- start -- read data*/
        var links = JSON.parse('{{ links | safe}}').map(u => ({ t: u.t, i: u.i, j: u.j }));
        var nodes = JSON.parse('{{ nodes | safe}}');
        dn.addNodes(nodes)
        dn.addRelationships(links)
        /* -- end -- read data*/





        var select = document.getElementById('select-categorized-feature');
        Object.keys(dn.features).forEach((f, i) => {
            let opt = document.createElement('option');
            opt.textContent = f;
            opt.value = f;
            if (i == 0) {
                gCate = f;
                opt.selected = true;
            }
            select.appendChild(opt)
        });



        const timeData = dn.getTimeline();

        var zoomFrom = document.getElementById("zoom-from")
        var zoomTo = document.getElementById("zoom-to")

        timeData.forEach((e, i) => {
            let optionF = document.createElement("option");
            let optionT = document.createElement("option");
            optionF.textContent = e;
            optionT.textContent = e;
            optionF.value = e;
            optionT.value = e;
            zoomFrom.appendChild(optionF);
            zoomTo.appendChild(optionT);
        });
        zoomFrom.selectedIndex = 0;
        zoomTo.selectedIndex = timeData.length - 1;


        var line = new vis.LineSummary('timeline-grid')
        var network = new vis.Network('network')


        var slider = new vis.Slider('range-slider', line.dataZoomBoundary(), 1)

        line.triggerRangeSlider(slider, zoomFrom, zoomTo);
        slider.bindNetwork(network);



        /*-- start -- resize diagram */
        window.onresize = function () {
            line.resize();
            network.resize();
        }
        /*-- end -- resize diagram */




    </script>


</body>

</html>